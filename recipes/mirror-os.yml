# yaml-language-server: $schema=https://schema.blue-build.org/recipe-v1.json
name: mirror-os
description: Mirror OS — base image
base-image: quay.io/fedora-ostree-desktops/cosmic-atomic
image-version: 43

modules:
  # Create the /nix mountpoint before any package operations.
  # The root filesystem is read-only at runtime (composefs), so this directory
  # must exist in the image itself — users cannot create it after booting.
  - type: script
    scripts:
      - create-nix-mountpoint.sh

  # Add RPM Fusion free and nonfree repositories.
  # These are required for freeworld codec replacements and future driver support.
  - type: rpm-ostree
    install:
      - https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-%OS_VERSION%.noarch.rpm
      - https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-%OS_VERSION%.noarch.rpm

  # Remove the restricted-codec free variants shipped in the base image and
  # replace them with the full freeworld versions in a single transaction.
  # Combining remove and install avoids the conflict that occurs when the free
  # counterparts are still present during the freeworld install.
  - type: rpm-ostree
    remove:
      - ffmpeg-free
      - libavcodec-free
      - libavdevice-free
      - libavfilter-free
      - libavformat-free
      - libavutil-free
      - libpostproc-free
      - libswresample-free
      - libswscale-free
    install:
      - ffmpeg
      - ffmpeg-libs
      - libavcodec-freeworld

  # Replace mesa-va-drivers with the freeworld variant to unlock H.264/HEVC
  # hardware decoding on Intel and AMD GPUs via VA-API.
  # Uses a build-time script because the override requires dnf download with
  # explicit --arch=x86_64 to avoid an unresolvable i686 spirv-tools-libs
  # dependency that appears in the container build context.
  - type: script
    scripts:
      - mesa-override.sh

  # Install GStreamer multimedia plugins.
  # VA-API GStreamer support is included in gstreamer1-plugins-bad-free on Fedora 43.
  - type: rpm-ostree
    install:
      - gstreamer1-plugins-base
      - gstreamer1-plugins-good
      - gstreamer1-plugins-good-extras
      - gstreamer1-plugins-bad-free
      - gstreamer1-plugins-bad-free-extras
      - gstreamer1-plugins-bad-freeworld
      - gstreamer1-plugins-ugly
      - gstreamer1-plugin-libav

  # Install system utilities baked into the image layer so they are available
  # before Nix is ready. Includes distrobox for containerized Linux environments,
  # the CUPS printing stack with HP driver support, font rendering libraries,
  # and the dpkg tool needed for the installer handler.
  - type: rpm-ostree
    install:
      - cups
      - distrobox
      - dpkg
      - git
      - hplip
      - inotify-tools
      - python3
      - rsms-inter-fonts
      - jetbrains-mono-fonts
      - google-noto-sans-fonts
      - google-noto-serif-fonts
      - google-noto-color-emoji-fonts
      - rsync
      - system-config-printer
      - zsh

  # Remove Firefox shipped in the base image; it is replaced by a Flatpak.
  - type: rpm-ostree
    remove:
      - firefox
      - firefox-langpacks

  # Copy configuration files into the image.
  # Source paths are relative to the repository's files/ directory.
  - type: files
    files:
      - source: usr
        destination: /usr
      - source: etc
        destination: /etc
      - source: cosign.pub
        destination: /etc/pki/mirror-os/cosign.pub
      - source: policy.json
        destination: /etc/containers/policy.json
      - source: registries.d/mirror-os.yaml
        destination: /etc/containers/registries.d/mirror-os.yaml
      - source: firewalld/services/localsend.xml
        destination: /etc/firewalld/services/localsend.xml
      - source: scripts/mirror-dev-reset.sh
        destination: /usr/bin/mirror-dev-reset
      - source: fonts/99-mirror-os-defaults.conf
        destination: /etc/fonts/conf.d/99-mirror-os-defaults.conf
      - source: usr/share/cosmic/
        destination: /usr/share/cosmic/

  # Enable Mirror OS systemd user units for all users.
  - type: script
    scripts:
      - enable-mirror-services.sh

  # Register Flatpak remotes on first boot for all users.
  # No app installs here — all Flatpaks are managed declaratively via nix-flatpak in Home Manager.
  - type: default-flatpaks
    configurations:
      - scope: system
        notify: true
        repo:
          url: https://dl.flathub.org/repo/flathub.flatpakrepo
          name: flathub
      - scope: system
        notify: false
        repo:
          url: https://distribute.kde.org/kdeapps.flatpakrepo
          name: kde

  # Make the first-boot scripts executable and enable their systemd services.
  # Must run after the files module so the scripts and unit files are present.
  - type: script
    scripts:
      - enable-services.sh
